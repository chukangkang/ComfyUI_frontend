# 负载均衡算法改进

## 问题描述

配置了 2 个后端节点，但打开 2 个浏览器标签页时，都连接到同一台后端机器。

## 原因分析

**旧算法（简单轮询）：**
- 第一个请求 → 服务器 1
- 第二个请求 → 服务器 2
- 第三个请求 → 服务器 1
- ...

**问题：** 同一个浏览器标签页的多个请求会连续发送（初始化时会发送几十个请求），结果：
- 浏览器标签 1：请求 1,3,5,7... → 都分配给服务器 1
- 浏览器标签 2：请求 2,4,6,8... → 都分配给服务器 2

实际效果是两个浏览器都用了同一台服务器（取决于打开顺序）。

## ✅ 新算法（客户端 IP 哈希）

**改进后的算法：**
```
客户端 IP → Hash → 取模 → 服务器索引
```

关键特性：
1. **同一个浏览器** → 相同的客户端 IP → 总是连接到**同一台服务器**
2. **不同的浏览器/PC** → 不同的客户端 IP → 可能连接到**不同的服务器**
3. **均衡分布** - 多个客户端会均匀分布在各个服务器上

## 工作原理

### 示例：配置 2 个服务器

```
服务器 1: http://server1:8188
服务器 2: http://server2:8188
```

客户端请求流程：

```
客户端 IP: 192.168.1.100
  → Hash = 19213
  → 19213 % 2 = 1
  → 路由到服务器 2 ✓ (所有请求都路由到服务器 2)

客户端 IP: 192.168.1.101
  → Hash = 19214
  → 19214 % 2 = 0
  → 路由到服务器 1 ✓ (所有请求都路由到服务器 1)

客户端 IP: 192.168.1.102
  → Hash = 19215
  → 19215 % 2 = 1
  → 路由到服务器 2 ✓
```

## 实际效果

### 场景：2 个浏览器标签 + 2 个服务器

**打开标签 1：**
```
GET / → [192.168.1.100] → 服务器 1
GET /api/info → [192.168.1.100] → 服务器 1
GET /api/queue → [192.168.1.100] → 服务器 1
WebSocket → [192.168.1.100] → 服务器 1
```

**打开标签 2（新浏览器实例或 IP 不同）：**
```
GET / → [192.168.1.101] → 服务器 2
GET /api/info → [192.168.1.101] → 服务器 2
GET /api/queue → [192.168.1.101] → 服务器 2
WebSocket → [192.168.1.101] → 服务器 2
```

✅ 现在两个标签页分别使用不同的服务器！

## 日志输出示例

启动开发服务器后，你会看到类似的日志：

```
[LoadBalancer] Loading servers from file: /root/ComfyUI_frontend/servers.json
[LoadBalancer] Loaded 2 servers from JSON array
[LoadBalancer] GET / → http://server1:8188 [client: 127.0.0.1]
[LoadBalancer] GET /api/config → http://server1:8188 [client: 127.0.0.1]
[LoadBalancer] POST /api/queue → http://server1:8188 [client: 127.0.0.1]
[LoadBalancer] WS /ws → http://server1:8188 [client: 127.0.0.1] (load balanced)
```

## 优势

| 特性 | 旧算法 | 新算法 |
|-----|--------|--------|
| 单个浏览器均衡 | ✗ | ✓ |
| 多个浏览器均衡 | ✓ | ✓ |
| 粘性连接 | ✗ | ✓ |
| WebSocket 支持 | 差 | 好 |
| 一致性哈希 | ✗ | ✓ |
| 服务器崩溃重定向 | ✗ | ✗ (需要扩展) |

## 测试方法

### 1. 配置 2 个本地服务器

```bash
# 终端 1
python main.py --port 8188

# 终端 2
python main.py --port 8189
```

### 2. 配置 .env

```env
DEV_SERVER_COMFYUI_URL=http://localhost:8188,http://localhost:8189
```

或使用文件：
```json
[
  "http://localhost:8188",
  "http://localhost:8189"
]
```

### 3. 打开多个浏览器标签/窗口

- 标签 1：http://localhost:5173
- 标签 2：http://localhost:5173 (在新窗口/标签打开)

### 4. 观察服务器日志和开发服务器日志

在 vite 开发服务器输出中查找：
```
[LoadBalancer] GET / → http://localhost:8188 [client: ...]
[LoadBalancer] GET / → http://localhost:8189 [client: ...]
```

如果看到不同的客户端 IP 分别连到不同服务器，说明负载均衡工作正常！

## 高级配置

如果需要更复杂的负载均衡（如故障转移、权重分配），可以：

1. 在后端（ComfyUI）添加健康检查
2. 实现加权轮询
3. 实现故障转移机制
4. 使用专门的负载均衡器（nginx, haproxy）

但对于开发环境，当前的一致性哈希已经足够了。

## 故障排除

### 问题：两个标签仍然连到同一个服务器

**可能原因：**
1. 两个标签页的客户端 IP 相同（比如都来自 127.0.0.1）
2. 只配置了 1 个服务器

**解决方案：**
- 使用不同的客户端 IP 进行测试
- 验证 servers.json 中确实配置了 2 个不同的 URL
- 检查日志中的 `[LoadBalancer] Loaded N servers` 是否正确

### 问题：WebSocket 连接失败

**原因：** WebSocket 需要长连接，必须路由到同一服务器

**状态：** ✓ 已支持 - 一致性哈希确保同一客户端 IP 的 WebSocket 总是连到同一服务器

## 总结

新算法使用**一致性哈希**实现基于客户端 IP 的会话粘性，确保：
- ✅ 同一个浏览器的所有请求都路由到同一台服务器
- ✅ 不同浏览器可以分配到不同服务器
- ✅ WebSocket 连接稳定
- ✅ 分布式环境下行为一致
